name: Weekly Calibration Refresh

on:
  workflow_dispatch:
  schedule:
    # Every Monday at 06:00 UTC (09:00 Istanbul)
    - cron: "0 6 * * 1"

permissions:
  contents: write
  actions: read

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  refresh:
    runs-on: ubuntu-latest

    env:
      # ---- Required and identity ----
      GIT_SHA: ${{ github.sha }}
      METACULUS_TOKEN: ${{ secrets.METACULUS_TOKEN }}

      # ---- Collections included in calibration (code reads by tournament id/collection) ----
      TOURNAMENT_ID: fall-aib-2025
      METACULUS_INCLUDE_RESOLVED: "1"   # calibration needs resolutions

      # ---- LLM Providers (not needed here; keep off) ----
      USE_OPENROUTER: "0"
      USE_GOOGLE: "0"
      ENABLE_GROK: "0"

      # ---- Paths for calibration artifacts ----
      CALIBRATION_PATH: calibration/calibration_state.json
      CALIB_WEIGHTS_PATH: calibration/calibration_weights.json
      CALIB_ADVICE_PATH: calibration/calibration_advice.json

      # ---- CSV output path for logs (optional; defaults exist) ----
      FORECASTS_CSV_PATH: forecasts.csv

      # ---- Cache toggles ----
      SPAGBOT_DISABLE_RESEARCH_CACHE: "1"  
      SPAGBOT_DISABLE_CLASSIFIER_CACHE: "0"

      # ---- Misc knobs used by code (safe defaults) ----
      LLM_MAX_CONCURRENCY: "4"
      RESEARCH_SNIPPET_MAX_CHARS: "600"
      HUMAN_LOG_MODEL_RAW_MAX_CHARS: "5000"
      HUMAN_LOG_RESEARCH_MAX_CHARS: "15000"

      # ---- Cost table (string JSON) ----
      MODEL_COSTS_JSON: |
        {"openai/gpt-4o":{"prompt":0.0025,"completion":0.01},"anthropic/claude-3.7-sonnet":{"prompt":0.003,"completion":0.015},"gemini-2.5-pro":{"prompt":0.00125,"completion":0.01},"grok-4":{"prompt":0.003,"completion":0.015}}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: pipx install poetry

      - name: Refresh lockfile
        run: poetry lock --no-interaction --no-ansi

      - name: Install deps
        run: poetry install --no-interaction --no-ansi

      - name: Refresh calibration (pull resolutions and update weights)
        run: poetry run python update_calibration.py

      - name: Commit forecast artifacts (if changed)
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Only add artifacts that exist (the CSV path lives under forecast_logs/)
          if [ -f forecast_logs/forecasts.csv ]; then
            git add forecast_logs/forecasts.csv
          else
            echo "No forecasts CSV found; skipping add."
          fi

          if [ -f Dashboard/data/forecasts.parquet ]; then
            git add -f Dashboard/data/forecasts.parquet
          else
            echo "No dashboard parquet found; skipping add."
          fi

          if git diff --cached --quiet; then
            echo "No forecast artifacts changed."
          else
            git commit -m "chore(ci): update forecasts [skip ci]"
            git push
          fi

      - name: Commit calibration artifacts (if changed)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add calibration/*.json || true
          if ! git diff --cached --quiet; then
            git commit -m "chore: weekly calibration refresh [skip ci]"
            git push
          else
            echo "No calibration changes to commit."
          fi
